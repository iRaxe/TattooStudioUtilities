import{j as o,r as d,g as R,I as w,A as V,B as v}from"./index-CFS5meP2.js";import{F as ae}from"./CalendarDaysIcon-Cp9xBLy9.js";const le=({className:l="",...m})=>o.jsx("textarea",{className:`glass-input ${l}`,...m});function ce({appointment:l,onSave:m,onCancel:j,tatuatori:p,stanze:f}){console.log("[DEBUG] AppointmentForm - Props ricevute:"),console.log("[DEBUG] Props tatuatori:",p),console.log("[DEBUG] Numero tatuatori ricevuti:",(p==null?void 0:p.length)||0),console.log("[DEBUG] Props stanze:",f),console.log("[DEBUG] Numero stanze ricevute:",(f==null?void 0:f.length)||0),console.log("[DEBUG] Props appointment:",l),console.log("[DEBUG] Props onSave:",typeof m),console.log("[DEBUG] Props onCancel:",typeof j);const[t,y]=d.useState({tatuatore_id:"",stanza_id:"",cliente_telefono:"",cliente_nome:"",orario_inizio:"",durata_minuti:60,note:"",stato:"confermato"}),[B,P]=d.useState(""),[I,L]=d.useState([]),[H,G]=d.useState(!1),[b,q]=d.useState(null),[O,W]=d.useState(!1),[u,F]=d.useState(!1),[T,x]=d.useState(""),[C,S]=d.useState(""),[Y,z]=d.useState(!1),[c,k]=d.useState(null),U={width:"100%",padding:"0.75rem",backgroundColor:"#000000",border:"1px solid rgba(255, 255, 255, 0.12)",borderRadius:"6px",color:"#f3f4f6",fontSize:"0.9rem"};d.useEffect(()=>(console.log("[DEBUG] AppointmentForm MONTATO"),console.log("[DEBUG] Props al mount:",{appointment:l,tatuatori:p,stanze:f,onSave:typeof m,onCancel:typeof j}),()=>{console.log("[DEBUG] AppointmentForm SMONTATO")}),[]),d.useEffect(()=>{l&&(console.log("[DEBUG] Popolamento form per modifica appuntamento:",l),y({tatuatore_id:l.tatuatore_id||"",stanza_id:l.stanza_id||"",cliente_telefono:l.cliente_telefono||"",cliente_nome:l.cliente_nome||"",orario_inizio:l.orario_inizio?new Date(l.orario_inizio).toISOString().slice(0,16):"",durata_minuti:l.durata_minuti||60,note:l.note||"",stato:l.stato||"confermato"}))},[l]),d.useEffect(()=>{t.tatuatore_id&&t.stanza_id&&t.orario_inizio&&K()},[t.tatuatore_id,t.stanza_id,t.orario_inizio,t.durata_minuti]);const _=e=>{const i=r=>r.toString().padStart(2,"0");return`${e.getUTCFullYear()}${i(e.getUTCMonth()+1)}${i(e.getUTCDate())}T${i(e.getUTCHours())}${i(e.getUTCMinutes())}${i(e.getUTCSeconds())}Z`},A=(e="")=>e.replace(/\\/g,"\\\\").replace(/\n/g,"\\n").replace(/,/g,"\\,").replace(/;/g,"\\;"),J=()=>{var E,M;if(!t.orario_inizio)return null;const e=new Date(t.orario_inizio);if(Number.isNaN(e.getTime()))return null;const i=Number(t.durata_minuti)||60,r=new Date(e.getTime()+i*6e4),s=p.find($=>$.id===t.tatuatore_id),n=f.find($=>$.id===t.stanza_id),a=(E=t.cliente_nome)==null?void 0:E.trim(),g=(M=t.cliente_telefono)==null?void 0:M.trim(),h=["Appuntamento Tatuaggio"];s!=null&&s.nome&&h.push(`con ${s.nome}`),a&&h.push(`- ${a}`);const N=[s!=null&&s.nome?`Tatuatore: ${s.nome}`:null,n!=null&&n.nome?`Stanza: ${n.nome}`:null,a?`Cliente: ${a}`:null,g?`Telefono: ${g}`:null,t.note?`Note: ${t.note}`:null].filter(Boolean);return{title:h.join(" "),description:N.join(`
`),location:(n==null?void 0:n.nome)||"",start:e,end:r,clientName:a||g||"appuntamento"}},Z=async e=>{var i;if(!e||e.length<3){console.log("[DEBUG] Ricerca clienti: telefono troppo corto o vuoto:",e),L([]);return}try{console.log("[DEBUG] Ricerca clienti per telefono:",e);const r=R("adminToken"),s="/api/admin/customers";console.log("[DEBUG] API URL ricerca clienti:",s),console.log("[DEBUG] Token presente:",!!r);const n=await fetch(s,{headers:{Authorization:`Bearer ${r}`}});if(console.log("[DEBUG] Response status ricerca clienti:",n.status),console.log("[DEBUG] Response ok:",n.ok),n.ok){const a=await n.json();console.log("[DEBUG] Dati clienti ricevuti:",a),console.log("[DEBUG] Numero totale clienti:",((i=a.customers)==null?void 0:i.length)||0);const g=a.customers.filter(h=>h.phone&&h.phone.includes(e)).slice(0,5);console.log("[DEBUG] Clienti filtrati per telefono:",e,"- Trovati:",g.length),console.log("[DEBUG] Clienti filtrati:",g),L(g),G(!0)}else{console.log("[DEBUG] Errore response ricerca clienti:",n.statusText);const a=await n.text();console.log("[DEBUG] Errore dettagliato ricerca clienti:",a)}}catch(r){console.error("[DEBUG] Errore ricerca clienti:",r),console.error("[DEBUG] Errore stack ricerca clienti:",r.stack)}},K=async()=>{if(!t.tatuatore_id||!t.stanza_id||!t.orario_inizio){console.log("[DEBUG] Verifica disponibilità: parametri mancanti",{tatuatore_id:t.tatuatore_id,stanza_id:t.stanza_id,orario_inizio:t.orario_inizio});return}W(!0);try{console.log("[DEBUG] Verifica disponibilità per:"),console.log("[DEBUG] Tatuatore ID:",t.tatuatore_id),console.log("[DEBUG] Stanza ID:",t.stanza_id),console.log("[DEBUG] Orario inizio:",t.orario_inizio),console.log("[DEBUG] Durata minuti:",t.durata_minuti);const e=R("adminToken"),i=t.orario_inizio.split("T")[0],s=`/api/admin/disponibilita?${new URLSearchParams({tatuatore_id:t.tatuatore_id,stanza_id:t.stanza_id,data:i,durata_minuti:t.durata_minuti})}`;console.log("[DEBUG] API URL verifica disponibilità:",s),console.log("[DEBUG] Token presente:",!!e);const n=await fetch(s,{headers:{Authorization:`Bearer ${e}`}});if(console.log("[DEBUG] Response status verifica disponibilità:",n.status),console.log("[DEBUG] Response ok:",n.ok),n.ok){const a=await n.json();console.log("[DEBUG] Dati disponibilità ricevuti:",a),console.log("[DEBUG] Slots disponibili:",a.slots_disponibili),console.log("[DEBUG] Conflicts:",a.conflicts),q(a)}else{console.log("[DEBUG] Errore response verifica disponibilità:",n.statusText);const a=await n.text();console.log("[DEBUG] Errore dettagliato verifica disponibilità:",a)}}catch(e){console.error("[DEBUG] Errore verifica disponibilità:",e),console.error("[DEBUG] Errore stack verifica disponibilità:",e.stack)}finally{W(!1)}};d.useEffect(()=>{const e=setTimeout(()=>{B?Z(B):G(!1)},300);return()=>clearTimeout(e)},[B]);const Q=e=>{y(i=>({...i,cliente_telefono:e.phone,cliente_nome:`${e.first_name} ${e.last_name}`})),P(e.phone),G(!1)},X=async e=>{e.preventDefault(),console.log("[DEBUG] Handle submit chiamato"),console.log("[DEBUG] FormData da salvare:",t);const i=[];if(t.tatuatore_id||i.push("Seleziona un tatuatore"),t.stanza_id||i.push("Seleziona una stanza"),t.orario_inizio||i.push("Seleziona data e ora"),(!t.durata_minuti||t.durata_minuti<15)&&i.push("Durata minima 15 minuti"),console.log("[DEBUG] Errori di validazione:",i),i.length>0){x(i.join(", "));return}F(!0),x(""),S(""),z(!1),k(null);try{const r=R("adminToken"),s=l?`/api/admin/appuntamenti/${l.id}`:"/api/admin/appuntamenti",n=l?"PUT":"POST";console.log("[DEBUG] Salvataggio appuntamento:"),console.log("[DEBUG] URL:",s),console.log("[DEBUG] Method:",n),console.log("[DEBUG] Token presente:",!!r),console.log("[DEBUG] Headers:",{"Content-Type":"application/json",Authorization:`Bearer ${r?"***PRESENT***":"MISSING"}`});const a=await fetch(s,{method:n,headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`},body:JSON.stringify(t)});console.log("[DEBUG] Response status salvataggio:",a.status),console.log("[DEBUG] Response ok:",a.ok);const g=await a.json();if(console.log("[DEBUG] Response data:",g),!a.ok){if(g.conflicts&&g.conflicts.length>0){const N=g.conflicts.map(E=>`${E.tatuatore_nome} in ${E.stanza_nome} dalle ${new Date(E.orario_inizio).toLocaleTimeString("it-IT")} per ${E.durata_minuti} min`).join(", ");console.log("[DEBUG] Conflitti rilevati:",g.conflicts),x(`Conflitto rilevato: ${N}. Procedere comunque?`);return}throw new Error(g.error||"Errore nel salvataggio appuntamento")}const h=J();console.log("[DEBUG] Dettagli evento calendario generati:",h),S(l?"Appuntamento aggiornato con successo!":"Appuntamento creato con successo!"),console.log("[DEBUG] Appuntamento salvato con successo"),l?setTimeout(()=>{m==null||m()},1500):h?(k({...h,uid:`tinkstudio-${Date.now()}`}),z(!0)):m==null||m()}catch(r){console.error("[DEBUG] Errore salvataggio:",r),console.error("[DEBUG] Errore stack salvataggio:",r.stack),x(r.message)}finally{F(!1)}},ee=()=>{if(!c)return;const e=new URL("https://calendar.google.com/calendar/render");e.searchParams.set("action","TEMPLATE"),e.searchParams.set("text",c.title||"Appuntamento Tatuaggio"),e.searchParams.set("dates",`${_(c.start)}/${_(c.end)}`),c.description&&e.searchParams.set("details",c.description),c.location&&e.searchParams.set("location",c.location),window.open(e.toString(),"_blank","noopener,noreferrer")},oe=()=>{if(!c)return;const e=["BEGIN:VCALENDAR","VERSION:2.0","PRODID:-//TinkStudio//Appointments//IT","CALSCALE:GREGORIAN","BEGIN:VEVENT",`UID:${c.uid}`,`DTSTAMP:${_(new Date)}`,`DTSTART:${_(c.start)}`,`DTEND:${_(c.end)}`,`SUMMARY:${A(c.title)}`];c.description&&e.push(`DESCRIPTION:${A(c.description)}`),c.location&&e.push(`LOCATION:${A(c.location)}`),e.push("END:VEVENT","END:VCALENDAR");const i=e.join(`\r
`),r=new Blob([i],{type:"text/calendar;charset=utf-8"}),s=URL.createObjectURL(r),n=document.createElement("a"),a=(c.clientName||"appuntamento").replace(/[\\/:*?"<>|]/g,"-");n.href=s,n.download=`${a}.ics`,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(s)},te=()=>{z(!1),k(null),m==null||m()},D=(e,i)=>{y(r=>({...r,[e]:i})),T&&x(""),C&&S("")},ie=p.find(e=>e.id===t.tatuatore_id),ne=f.find(e=>e.id===t.stanza_id);return console.log("[DEBUG] AppointmentForm rendering completato"),console.log("[DEBUG] FormData attuale:",t),console.log("[DEBUG] Tatuatore selezionato:",ie),console.log("[DEBUG] Stanza selezionata:",ne),o.jsxs("div",{children:[o.jsxs("h3",{className:"section-title",children:[o.jsx(ae,{className:"section-title-icon","aria-hidden":"true"})," ",l?"Modifica Appuntamento":"Nuovo Appuntamento"]}),o.jsxs("form",{onSubmit:X,children:[o.jsxs("div",{style:{display:"grid",gap:"1.5rem",gridTemplateColumns:"repeat(auto-fit, minmax(250px, 1fr))"},children:[o.jsx("div",{children:(console.log("[DEBUG] Rendering select tatuatore:"),console.log("[DEBUG] Tatuatori disponibili per select:",(p==null?void 0:p.length)||0),console.log("[DEBUG] Lista tatuatori per select:",p||[]),console.log("[DEBUG] Valore selezionato tatuatore_id:",t.tatuatore_id),o.jsxs(o.Fragment,{children:[o.jsx("label",{style:{color:"#fbbf24",fontSize:"0.9rem",fontWeight:"600",display:"block",marginBottom:"0.5rem"},children:"Tatuatore *"}),o.jsxs("select",{value:t.tatuatore_id,onChange:e=>D("tatuatore_id",e.target.value),style:U,disabled:u,children:[o.jsx("option",{value:"",children:"Seleziona tatuatore..."}),p.map(e=>o.jsxs("option",{value:e.id,children:[e.nome," ",e.attivo?"":"(Disattivo)"]},e.id))]})]}))}),o.jsx("div",{children:(console.log("[DEBUG] Rendering select stanza:"),console.log("[DEBUG] Stanze disponibili per select:",(f==null?void 0:f.length)||0),console.log("[DEBUG] Lista stanze per select:",f||[]),console.log("[DEBUG] Valore selezionato stanza_id:",t.stanza_id),o.jsxs(o.Fragment,{children:[o.jsx("label",{style:{color:"#fbbf24",fontSize:"0.9rem",fontWeight:"600",display:"block",marginBottom:"0.5rem"},children:"Stanza *"}),o.jsxs("select",{value:t.stanza_id,onChange:e=>D("stanza_id",e.target.value),style:U,disabled:u,children:[o.jsx("option",{value:"",children:"Seleziona stanza..."}),f.map(e=>o.jsxs("option",{value:e.id,children:[e.nome," ",e.no_overbooking?"(No Overbooking)":"",e.attivo?"":" (Disattiva)"]},e.id))]})]}))}),o.jsxs("div",{style:{position:"relative"},children:[o.jsx("label",{style:{color:"#fbbf24",fontSize:"0.9rem",fontWeight:"600",display:"block",marginBottom:"0.5rem"},children:"Telefono Cliente"}),o.jsx(w,{type:"tel",value:B,onChange:e=>P(e.target.value.replace(/\D/g,"")),placeholder:"Cerca per telefono...",disabled:u}),H&&I.length>0&&o.jsx("div",{style:{position:"absolute",top:"100%",left:0,right:0,background:"rgba(0, 0, 0, 0.9)",border:"1px solid rgba(255, 255, 255, 0.2)",borderRadius:"4px",marginTop:"0.25rem",zIndex:1e3,backdropFilter:"blur(10px)",maxHeight:"200px",overflowY:"auto"},children:I.map(e=>o.jsxs("div",{onClick:()=>Q(e),style:{padding:"0.75rem",cursor:"pointer",borderBottom:"1px solid rgba(255, 255, 255, 0.1)",color:"#f3f4f6"},onMouseEnter:i=>{i.target.style.background="rgba(255, 255, 255, 0.1)"},onMouseLeave:i=>{i.target.style.background="transparent"},children:[o.jsxs("div",{style:{fontWeight:"500"},children:[e.first_name," ",e.last_name]}),o.jsxs("div",{style:{fontSize:"0.8rem",color:"#9ca3af"},children:["Telefono: ",e.phone]})]},e.phone))})]}),o.jsxs("div",{children:[o.jsx("label",{style:{color:"#fbbf24",fontSize:"0.9rem",fontWeight:"600",display:"block",marginBottom:"0.5rem"},children:"Nome Cliente"}),o.jsx(w,{type:"text",value:t.cliente_nome,onChange:e=>D("cliente_nome",e.target.value),placeholder:"Nome del cliente",disabled:u})]}),o.jsxs("div",{children:[o.jsx("label",{style:{color:"#fbbf24",fontSize:"0.9rem",fontWeight:"600",display:"block",marginBottom:"0.5rem"},children:"Data e Ora Inizio *"}),o.jsx(w,{type:"datetime-local",value:t.orario_inizio,onChange:e=>D("orario_inizio",e.target.value),disabled:u,min:new Date().toISOString().slice(0,16)})]}),o.jsxs("div",{children:[o.jsx("label",{style:{color:"#fbbf24",fontSize:"0.9rem",fontWeight:"600",display:"block",marginBottom:"0.5rem"},children:"Durata (minuti) *"}),o.jsxs("select",{value:t.durata_minuti,onChange:e=>D("durata_minuti",parseInt(e.target.value)),style:U,disabled:u,children:[o.jsx("option",{value:15,children:"15 minuti"}),o.jsx("option",{value:30,children:"30 minuti"}),o.jsx("option",{value:60,children:"1 ora"}),o.jsx("option",{value:90,children:"1 ora 30 min"}),o.jsx("option",{value:120,children:"2 ore"}),o.jsx("option",{value:180,children:"3 ore"}),o.jsx("option",{value:240,children:"4 ore"})]})]}),l&&o.jsxs("div",{children:[o.jsx("label",{style:{color:"#fbbf24",fontSize:"0.9rem",fontWeight:"600",display:"block",marginBottom:"0.5rem"},children:"Stato"}),o.jsxs("select",{value:t.stato,onChange:e=>D("stato",e.target.value),style:U,disabled:u,children:[o.jsx("option",{value:"confermato",children:"Confermato"}),o.jsx("option",{value:"in_corso",children:"In Corso"}),o.jsx("option",{value:"completato",children:"Completato"}),o.jsx("option",{value:"cancellato",children:"Cancellato"})]})]}),o.jsxs("div",{style:{gridColumn:"1 / -1"},children:[o.jsx("label",{style:{color:"#fbbf24",fontSize:"0.9rem",fontWeight:"600",display:"block",marginBottom:"0.5rem"},children:"Note"}),o.jsx(le,{value:t.note,onChange:e=>D("note",e.target.value),placeholder:"Note aggiuntive sull'appuntamento...",style:{minHeight:"100px",resize:"vertical"},disabled:u})]})]}),O&&o.jsx("div",{style:{marginTop:"1rem",padding:"1rem",background:"rgba(251, 191, 36, 0.1)",border:"1px solid rgba(251, 191, 36, 0.3)",borderRadius:"4px"},children:o.jsx("div",{style:{color:"#fbbf24"},children:"Verifica disponibilità in corso..."})}),b&&!O&&o.jsxs("div",{style:{marginTop:"1rem",padding:"1rem",background:b.slots_disponibili>0?"rgba(34, 197, 94, 0.1)":"rgba(239, 68, 68, 0.1)",border:`1px solid ${b.slots_disponibili>0?"rgba(34, 197, 94, 0.3)":"rgba(239, 68, 68, 0.3)"}`,borderRadius:"4px"},children:[o.jsx("div",{style:{color:b.slots_disponibili>0?"#22c55e":"#ef4444",fontWeight:"600"},children:b.slots_disponibili>0?`Disponibile (${b.slots_disponibili} slot liberi)`:"Non disponibile"}),b.conflicts&&b.conflicts.length>0&&o.jsxs("div",{style:{marginTop:"0.5rem",fontSize:"0.9rem"},children:[o.jsx("div",{style:{color:"#f59e0b",fontWeight:"600"},children:"Attenzione: conflitti rilevati"}),b.conflicts.map((e,i)=>o.jsxs("div",{style:{color:"#f3f4f6",marginTop:"0.25rem"},children:[e.tatuatore_nome," in ",e.stanza_nome," dalle"," ",new Date(e.orario_inizio).toLocaleTimeString("it-IT")]},i))]})]}),T&&o.jsx(V,{type:"error",style:{marginTop:"1rem"},children:T}),C&&o.jsx(V,{type:"success",style:{marginTop:"1rem"},children:C}),Y&&c&&o.jsxs("div",{style:{marginTop:"1rem",padding:"1.25rem",background:"rgba(16, 185, 129, 0.12)",border:"1px solid rgba(16, 185, 129, 0.3)",borderRadius:"6px"},children:[o.jsx("div",{style:{color:"#34d399",fontWeight:"600",marginBottom:"0.75rem"},children:"Aggiungere l'appuntamento al tuo calendario?"}),o.jsx("div",{style:{color:"#e5e7eb",fontSize:"0.9rem",marginBottom:"1rem",lineHeight:"1.4"},children:"Puoi salvarlo su Google Calendar oppure scaricare un promemoria (.ics) compatibile con Apple Calendar, Outlook e la maggior parte dei calendari moderni."}),o.jsxs("div",{style:{display:"flex",flexWrap:"nowrap",gap:"0.75rem"},children:[o.jsx(v,{type:"button",onClick:ee,disabled:u,style:{width:"auto",minWidth:"auto",flex:"0 0 auto",maxWidth:"none"},children:"Aggiungi su Google Calendar"}),o.jsx(v,{type:"button",variant:"secondary",onClick:oe,disabled:u,style:{width:"auto",minWidth:"auto",flex:"0 0 auto",maxWidth:"none"},children:"Scarica promemoria (.ics)"}),o.jsx(v,{type:"button",variant:"ghost",onClick:te,disabled:u,style:{width:"auto",minWidth:"auto",flex:"0 0 auto",maxWidth:"none"},children:"Fatto"})]})]}),o.jsxs("div",{style:{display:"flex",gap:"1rem",marginTop:"2rem",justifyContent:"flex-end"},children:[o.jsx(v,{type:"button",variant:"secondary",onClick:j,disabled:u,children:"Annulla"}),o.jsx(v,{type:"submit",disabled:u||!t.tatuatore_id||!t.stanza_id||!t.orario_inizio,children:u?"Salvataggio in corso...":l?"Aggiorna":"Salva"})]})]})]})}export{ce as default};
